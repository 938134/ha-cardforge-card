name: æž„å»ºå¹¶å‘å¸ƒ

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      # ---------- æ£€å‡º ----------
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # ---------- åŒæ­¥æ ‡ç­¾ ----------
      - name: èŽ·å–å¹¶æ¸…ç†æ ‡ç­¾
        run: |
          git fetch --tags --force
          echo "ä»Šæ—¥å·²æœ‰æ ‡ç­¾ï¼š"
          git tag -l "v$(date +%Y%m%d)*" | sort -V || true

      # ---------- Node çŽ¯å¢ƒ ----------
      - name: å®‰è£… Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: å®‰è£…ä¾èµ–
        run: npm install

      # ---------- ç¼–è¯‘ ----------
      - name: æž„å»ºé¡¹ç›®
        run: npm run build

      # ---------- è®¡ç®—ç‰ˆæœ¬å· ----------
      - name: ç”Ÿæˆç‰ˆæœ¬å·
        id: version
        run: |
          export TZ=Asia/Shanghai
          DATE=$(date +%Y%m%d)
          MAX_NUM=$(git tag -l "v${DATE}*" | grep -oE '[0-9]{2}$' | sort -nr | head -1)
          MAX_NUM=${MAX_NUM:-0}
          NEXT_NUM=$((10#$MAX_NUM + 1))
          NEW_VERSION="v${DATE}$(printf '%02d' $NEXT_NUM)"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "æœ¬æ¬¡ç‰ˆæœ¬ï¼š$NEW_VERSION"

      # ---------- æ£€æŸ¥æž„å»ºäº§ç‰© ----------
      - name: æ£€æŸ¥æž„å»ºç»“æžœ
        run: |
          echo "=== æž„å»ºæ–‡ä»¶ ==="
          ls -la ha-cardforge-card.js
          echo "=== æ–‡ä»¶å¤§å° ==="
          du -h ha-cardforge-card.js

      # ---------- ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž ----------
      - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
        run: |
          cat > release-notes.md << EOF
          # HA-CardForge æ™ºèƒ½å¡ç‰‡å·¥åŠ

          ## ðŸš€ å®‰è£…æ–¹å¼

          åœ¨ HACS â†’ **å‰ç«¯** â†’ **è‡ªå®šä¹‰ä»“åº“** ä¸­æ·»åŠ ï¼š
          \`https://github.com/${{ github.repository }}\`

          ç„¶åŽæœç´¢ **CardForge** è¿›è¡Œå®‰è£…ã€‚

          ## ðŸ“¦ ç‰ˆæœ¬ç‰¹æ€§

          ### ðŸŽ¯ æ ¸å¿ƒåŠŸèƒ½
          - **æ’ä»¶åŒ–æž¶æž„** - è‡ªåŠ¨å‘çŽ°å’ŒåŠ è½½å¡ç‰‡æ’ä»¶
          - **å¯è§†åŒ–ç¼–è¾‘å™¨** - ç›´è§‚çš„é…ç½®ç•Œé¢ï¼Œå®žæ—¶é¢„è§ˆ
          - **æ™ºèƒ½æ•°æ®ç®¡ç†** - ä¸‰ç§å®žä½“ç­–ç•¥ï¼ˆè‡ªç”±å¸ƒå±€/ç»“æž„åŒ–/æ— çŠ¶æ€ï¼‰
          - **ç»Ÿä¸€é…ç½®ç³»ç»Ÿ** - åŸºç¡€è®¾ç½® + é«˜çº§è®¾ç½®åˆ†ç¦»

          ### ðŸŽ¨ ä¸»é¢˜ç³»ç»Ÿ
          - è‡ªåŠ¨ä¸»é¢˜ï¼ˆè·Ÿéšç³»ç»Ÿæ˜Žæš—æ¨¡å¼ï¼‰
          - çŽ»ç’ƒä¸»é¢˜ã€æ¸å˜ä¸»é¢˜ã€éœ“è™¹ä¸»é¢˜ã€æ°´å¢¨ä¸»é¢˜
          - å®Œæ•´çš„å“åº”å¼è®¾è®¡

          ### ðŸ§© å†…ç½®æ’ä»¶
          - æ—¶é’Ÿå¡ç‰‡ã€å‘¨åŽ†å¡ç‰‡
          - æ¬¢è¿Žå¡ç‰‡ã€ä»ªè¡¨ç›˜å¡ç‰‡  
          - è¯—è¯å¡ç‰‡ç­‰æ–‡åŒ–ç±»æ’ä»¶

          ## ðŸ”§ ä½¿ç”¨æŒ‡å—

          1. å®‰è£…åŽé‡å¯ Home Assistant
          2. åœ¨ Lovelace ä¸­æ·»åŠ è‡ªå®šä¹‰å¡ç‰‡
          3. é€‰æ‹© "HA-CardForge" å¡ç‰‡ç±»åž‹
          4. æŒ‰ç…§é…ç½®å‘å¯¼å®Œæˆè®¾ç½®ï¼š
            - é€‰æ‹©å¡ç‰‡æ’ä»¶
            - è®¾ç½®ä¸»é¢˜æ ·å¼
            - é…ç½®åŸºç¡€å¤–è§‚
            - ç»‘å®šæ•°æ®æº

          ## ðŸ“ æ›´æ–°æ—¥å¿—

          åŸºäºŽæäº¤ ${{ github.sha }} è‡ªåŠ¨æž„å»º

          ### ä¸»è¦æ”¹è¿›
          - ä¼˜åŒ–é…ç½®ç•Œé¢å¸ƒå±€å’Œç”¨æˆ·ä½“éªŒ
          - å¢žå¼ºæ’ä»¶ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œæ‰©å±•æ€§
          - æ”¹è¿›å®žä½“éªŒè¯å’Œæ•°æ®ç»‘å®šæœºåˆ¶

          ## ðŸ†˜ èŽ·å–å¸®åŠ©

          - ðŸ“š æŸ¥çœ‹å®Œæ•´æ–‡æ¡£å’Œç¤ºä¾‹
          - ðŸ› æŠ¥å‘Šé—®é¢˜æˆ–å»ºè®®
          - ðŸ’¬ å‚ä¸Žç¤¾åŒºè®¨è®º

          **å¼€å§‹æž„å»ºä½ çš„å®Œç¾Žæ™ºèƒ½å®¶å±…ä»ªè¡¨ç›˜ï¼** ðŸŽ‰
          EOF

      # ---------- å¯é€‰ï¼šåˆ é™¤åŒå release ----------
      - name: è‹¥å·²å­˜åœ¨åˆ™åˆ é™¤æ—§ç‰ˆ Release
        continue-on-error: true
        run: gh release delete "${{ steps.version.outputs.version }}" --cleanup-tag -y
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ---------- åˆ›å»º Release ----------
      - name: åˆ›å»º Release
        uses: ncipollo/release-action@v1.14.0
        with:
          artifacts: "ha-cardforge-card.js"
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ steps.version.outputs.version }}
          name: ${{ steps.version.outputs.version }}
          bodyFile: "release-notes.md"
          makeLatest: true
          skipIfReleaseExists: false

      # ---------- æ¸…ç†ä¸´æ—¶æ–‡ä»¶ ----------
      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        run: |
          rm -f release-notes.md
          echo "æž„å»ºå®Œæˆ"
