name: 构建并发布

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      # ---------- 检出 ----------
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # ---------- 同步标签 ----------
      - name: 获取并清理标签
        run: |
          git fetch --tags --force
          echo "今日已有标签："
          git tag -l "v$(date +%Y%m%d)*" | sort -V || true

      # ---------- Node 环境 ----------
      - name: 安装 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: 安装依赖
        run: npm install

      # ---------- 编译 ----------
      - name: 构建项目
        run: npm run build

      # ---------- 计算版本号 ----------
      - name: 生成版本号
        id: version
        run: |
          export TZ=Asia/Shanghai
          DATE=$(date +%Y%m%d)
          MAX_NUM=$(git tag -l "v${DATE}*" | grep -oE '[0-9]{2}$' | sort -nr | head -1)
          MAX_NUM=${MAX_NUM:-0}
          NEXT_NUM=$((10#$MAX_NUM + 1))
          NEW_VERSION="v${DATE}$(printf '%02d' $NEXT_NUM)"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "本次版本：$NEW_VERSION"

      # ---------- 检查构建产物 ----------
      - name: 检查构建结果
        run: |
          echo "=== 构建结果 ==="
          ls -la dist/
          if [ -d "dist/plugins" ]; then
            echo "=== 插件目录内容 ==="
            ls -la dist/plugins/
            echo "=== 插件文件列表 ==="
            find dist/plugins/ -name "*.js" | sort
          fi

      # ---------- 准备发布文件 ----------
      - name: 准备发布文件
        run: |
          # 创建发布目录
          mkdir -p release
          # 复制主文件
          cp dist/ha-cardforge-card.js release/
          # 复制插件目录
          if [ -d "dist/plugins" ]; then
            cp -r dist/plugins release/
          fi
          echo "=== 发布文件结构 ==="
          find release/ -type f | sort
          echo "=== 发布目录大小 ==="
          du -sh release/

      # ---------- 创建压缩包 ----------
      - name: 创建压缩包
        run: |
          echo "=== 创建压缩包 ==="
          cd release
          tar -czf ../ha-cardforge-card-${{ steps.version.outputs.version }}.tar.gz ./*
          cd ..
          echo "=== 压缩包内容 ==="
          tar -tzf ha-cardforge-card-${{ steps.version.outputs.version }}.tar.gz | head -20
          echo "=== 压缩包大小 ==="
          ls -lh ha-cardforge-card-${{ steps.version.outputs.version }}.tar.gz

      # ---------- 生成发布说明 ----------
      - name: 生成发布说明
        run: |
          # 获取插件列表
          PLUGIN_LIST=""
          if [ -d "release/plugins" ]; then
            PLUGIN_LIST=$(find release/plugins -name "*.js" -exec basename {} \; | sort | sed 's/^/- `/; s/$/`/')
          fi
          
          cat > release-body.md << EOF
          ## 安装方式

          ### 方式一：完整包安装（推荐）
          1. 下载 \`ha-cardforge-card-${{ steps.version.outputs.version }}.tar.gz\`
          2. 解压到 Home Assistant 的 \`www/\` 目录：
             \`\`\`bash
             tar -xzf ha-cardforge-card-${{ steps.version.outputs.version }}.tar.gz -C /path/to/your/config/www/
             \`\`\`
          3. 在 Lovelace 配置中添加资源：
             \`\`\`yaml
             resources:
               - url: /local/ha-cardforge-card.js
                 type: module
             \`\`\`

          ### 方式二：单独文件安装
          1. 下载 \`ha-cardforge-card.js\` 文件
          2. 下载 plugins 目录下的所有插件文件
          3. 创建目录结构：
             \`\`\`
             www/
             ├── ha-cardforge-card.js
             └── plugins/
                 ├── time-week.js
                 ├── time-card.js
                 └── ...
             \`\`\`
          4. 在 Lovelace 配置中添加资源：
             \`\`\`yaml
             resources:
               - url: /local/ha-cardforge-card.js
                 type: module
             \`\`\`

          ### HACS 安装
          在 HACS → **前端** → **自定义仓库** 中添加：
          \`https://github.com/${{ github.repository }}\`

          ## 包含文件

          ### 主文件
          - \`ha-cardforge-card.js\` - 主卡片文件（必需）

          ### 插件文件
          ${PLUGIN_LIST}

          ## 更新日志
          - 基于提交 ${{ github.sha }} 自动构建

          ## 版本信息
          - 版本: ${{ steps.version.outputs.version }}
          - 提交: ${{ github.sha }}
          - 构建时间: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          EOF
          
          echo "=== 生成的发布说明 ==="
          cat release-body.md

      # ---------- 可选：删除同名 release ----------
      - name: 若已存在则删除旧版 Release
        continue-on-error: true
        run: gh release delete "${{ steps.version.outputs.version }}" --cleanup-tag -y
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ---------- 创建 Release ----------
      - name: 创建 Release
        uses: ncipollo/release-action@v1.14.0
        with:
          artifacts: "ha-cardforge-card-${{ steps.version.outputs.version }}.tar.gz,release/**"
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ steps.version.outputs.version }}
          name: ${{ steps.version.outputs.version }}
          bodyFile: "release-body.md"
          makeLatest: true
          skipIfReleaseExists: false

      # ---------- 清理临时文件 ----------
      - name: 清理临时文件
        run: |
          echo "=== 清理临时文件 ==="
          rm -rf release
          rm -f ha-cardforge-card-*.tar.gz
          rm -f release-body.md
          echo "清理完成"