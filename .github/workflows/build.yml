name: 构建并发布

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      # ---------- 检出 ----------
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # ---------- 同步标签 ----------
      - name: 获取并清理标签
        run: |
          git fetch --tags --force
          echo "今日已有标签："
          git tag -l "v$(date +%Y%m%d)*" | sort -V || true

      # ---------- Node 环境 ----------
      - name: 安装 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: 安装依赖
        run: npm install

      # ---------- 编译 ----------
      - name: 构建项目
        run: npm run build

      # ---------- 计算版本号 ----------
      - name: 生成版本号
        id: version
        run: |
          export TZ=Asia/Shanghai
          DATE=$(date +%Y%m%d)
          MAX_NUM=$(git tag -l "v${DATE}*" | grep -oE '[0-9]{2}$' | sort -nr | head -1)
          MAX_NUM=${MAX_NUM:-0}
          NEXT_NUM=$((10#$MAX_NUM + 1))
          NEW_VERSION="v${DATE}$(printf '%02d' $NEXT_NUM)"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "本次版本：$NEW_VERSION"

      # ---------- 生成 release notes ----------
      - name: 生成更新说明
        run: |
          cat <<EOF > release-notes.md
          ## 安装方式
          在 HACS → **前端** → **自定义仓库** 中添加  
          \`https://github.com/${{ github.repository }}\`

          ## 更新日志
          - 基于提交 ${{ github.sha }} 构建 dist/ha-cardforge.js
          EOF

      # ---------- 可选：删除同名 release ----------
      - name: 若已存在则删除旧版 Release
        continue-on-error: true
        run: gh release delete "${{ steps.version.outputs.version }}" --cleanup-tag -y
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ---------- 创建 Release ----------
      - name: 创建 Release
        uses: ncipollo/release-action@v1.14.0
        with:
          artifacts: "dist/ha-cardforge.js"
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ steps.version.outputs.version }}
          name: 发布 ${{ steps.version.outputs.version }}
          bodyFile: ./release-notes.md
          makeLatest: true
          skipIfReleaseExists: true

      # ---------- 回写 dist ----------
      - name: 提交并推送 dist 文件
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add dist/ha-cardforge.js
          git diff --staged --quiet || git commit -m "bot: 发布 ${{ steps.version.outputs.version }}"
          git push
